name: PR Parallel Quality Gates

on:
  pull_request:
    branches:
      - main
      - '**'

jobs:
  frontend-checks:
    name: Frontend Checks
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: './client/package-lock.json'

      # Cache node_modules for faster installs
      - name: Cache node_modules
        uses: actions/cache@v4
        id: node-modules-cache
        with:
          path: client/node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('client/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-

      # Cache TypeScript build outputs
      - name: Cache TypeScript build
        uses: actions/cache@v4
        id: ts-cache
        with:
          path: client/js
          key: ${{ runner.os }}-ts-build-${{ hashFiles('client/src/**/*.ts', 'client/tsconfig.json') }}
          restore-keys: |
            ${{ runner.os }}-ts-build-

      # Cache Jest test results
      - name: Cache Jest
        uses: actions/cache@v4
        id: jest-cache
        with:
          path: |
            client/.jest-cache
            client/coverage
          key: ${{ runner.os }}-jest-${{ hashFiles('client/src/**/*.ts', 'client/jest.config.js') }}
          restore-keys: |
            ${{ runner.os }}-jest-

      # Cache ESLint cache
      - name: Cache ESLint
        uses: actions/cache@v4
        id: eslint-cache
        with:
          path: client/.eslintcache
          key: ${{ runner.os }}-eslint-${{ hashFiles('client/src/**/*.ts', 'client/eslint.config.mjs') }}
          restore-keys: |
            ${{ runner.os }}-eslint-

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Install dependencies (frontend)
        working-directory: ./client
        if: steps.node-modules-cache.outputs.cache-hit != 'true'
        run: npm ci

      - name: Install Playwright browsers
        working-directory: ./client
        if: (steps.playwright-cache.outputs.cache-hit != 'true') && (startsWith(github.base_ref, 'release') || startsWith(github.head_ref, 'release'))
        run: npx playwright install --with-deps

      - name: Install Playwright system dependencies
        working-directory: ./client
        if: (steps.playwright-cache.outputs.cache-hit == 'true') && (startsWith(github.base_ref, 'release') || startsWith(github.head_ref, 'release'))
        run: npx playwright install-deps

      - name: Lint (frontend)
        working-directory: ./client
        run: npx eslint "src/**/*.ts" --cache --cache-location .eslintcache

      - name: Type Check (frontend)
        working-directory: ./client
        run: npx tsc --noEmit --incremental

      - name: Unit Tests (frontend)
        working-directory: ./client
        run: npx jest --testPathIgnorePatterns=/integration/ --testPathIgnorePatterns=/e2e/ --cache

      # TODO: Re-enable integration tests once supertest v7 compatibility issues resolved
      # - name: Integration Tests (frontend)
      #   working-directory: ./client
      #   run: npx jest --config jest.integration.config.js
      #   Note: Temporarily disabled due to supertest v7 compatibility issues with mock server
      
      - name: E2E Tests (frontend)
        working-directory: ./client
        if: startsWith(github.base_ref, 'release') || startsWith(github.head_ref, 'release')
        run: npx playwright test
        env:
          CI: true

      - name: Coverage Report (frontend)
        working-directory: ./client
        run: npx jest --coverage --cache

      - name: Coverage Threshold Check
        working-directory: ./client
        run: |
          # Adjust the threshold as needed
          THRESHOLD=85
          # Extract statements coverage percentage from HTML (first percentage after "All files")
          COVERAGE=$(grep -A 10 "All files" coverage/lcov-report/index.html | grep -oE 'class="strong">[0-9]+\.[0-9]+%' | head -1 | grep -oE '[0-9]+\.[0-9]+')
          if [ -z "$COVERAGE" ]; then
            echo "Failed to extract coverage percentage"
            exit 1
          fi
          echo "Detected coverage: $COVERAGE%"
          # Use awk for floating point comparison (bc might not be installed)
          COMPARE=$(echo "$COVERAGE $THRESHOLD" | awk '{if ($1 < $2) print 1; else print 0}')
          if [ "$COMPARE" = "1" ]; then
            echo "Coverage ($COVERAGE%) is below threshold ($THRESHOLD%)"
            exit 1
          fi
          echo "Coverage check passed: $COVERAGE% >= $THRESHOLD%"

      - name: Cleanup on failure
        if: failure()
        run: |
          echo "Cleaning up after failed frontend job..."
          rm -rf client/node_modules
          rm -rf client/coverage
          rm -rf client/.eslintcache
          rm -rf client/.jest-cache

  backend-checks:
    name: Backend Checks
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Cache Bazel
        uses: actions/cache@v4
        with:
          path: ~/.cache/bazel
          key: ${{ runner.os }}-bazel-${{ hashFiles('.bazelversion', 'MODULE.bazel', 'MODULE.bazel.lock', '**/*.bzl', 'server/BUILD.bazel') }}
          restore-keys: |
            ${{ runner.os }}-bazel-

      - name: Install Bazelisk
        run: |
          ARCH=$(uname -m)
          case $ARCH in
            x86_64) BAZELISK_ARCH="amd64" ;;
            aarch64|arm64) BAZELISK_ARCH="arm64" ;;
            *) echo "Unsupported arch: $ARCH"; exit 1 ;;
          esac
          curl -LO "https://github.com/bazelbuild/bazelisk/releases/download/v1.19.0/bazelisk-linux-${BAZELISK_ARCH}"
          chmod +x "bazelisk-linux-${BAZELISK_ARCH}"
          sudo mv "bazelisk-linux-${BAZELISK_ARCH}" /usr/local/bin/bazel
          bazel --version

      - name: Build & Test (backend)
        run: |
          bazel build //server:delerium_server_deploy
          bazel test //server:all_tests --test_output=errors

      - name: Cleanup on failure
        if: failure()
        run: |
          echo "Cleaning up after failed backend job..."
          bazel clean --expunge || true

  docker-checks:
    name: Docker Checks
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Improved Docker layer caching with buildx cache
      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Create .env file for CI
        run: |
          echo "DELETION_TOKEN_PEPPER=test-pepper-for-ci-$(date +%s)" > .env
          echo ".env file created for CI"

      - name: Docker Compose config validation
        run: docker compose -f docker-compose.yml config

      - name: Build Docker images
        run: docker compose -f docker-compose.yml build --parallel

      - name: Start Docker services
        run: docker compose -f docker-compose.yml up -d

      - name: Wait for services to be healthy
        run: |
          echo "Waiting for services to start..."
          sleep 30
          
          # Show container status
          docker compose -f docker-compose.yml ps
          
          # Check if services are running
          if ! docker compose -f docker-compose.yml ps | grep -qE "(Up|running)"; then
            echo "No containers are in 'Up' or 'running' state"
            docker compose -f docker-compose.yml ps
            docker compose -f docker-compose.yml logs
            exit 1
          fi
          
          # Check for exited containers
          if docker compose -f docker-compose.yml ps | grep -q "Exited"; then
            echo "Some containers have exited"
            docker compose -f docker-compose.yml ps
            docker compose -f docker-compose.yml logs
            exit 1
          fi

          # Test nginx is responding (with retries)
          echo "Testing nginx health endpoint..."
          NGINX_HEALTHY=false
          for i in {1..5}; do
            if timeout 5 curl -f http://localhost:8080 > /dev/null 2>&1; then
              echo "Nginx is responding!"
              NGINX_HEALTHY=true
              break
            fi
            echo "Attempt $i failed, retrying in 2 seconds..."
            sleep 2
          done
          
          if [ "$NGINX_HEALTHY" != "true" ]; then
            echo "Nginx health check failed after 5 attempts"
            docker compose -f docker-compose.yml logs
            exit 1
          fi

          echo "All services healthy!"

      - name: Stop and cleanup Docker services
        if: always()
        run: docker compose -f docker-compose.yml down -v

      - name: Cleanup on failure
        if: failure()
        run: |
          echo "Cleaning up after failed docker job..."
          docker compose -f docker-compose.yml down -v 2>/dev/null || true

  summary:
    name: PR Checks Summary
    runs-on: ubuntu-24.04
    needs: [frontend-checks, backend-checks, docker-checks]
    if: always()
    steps:
      - name: Check results
        run: |
          FRONTEND_RESULT="${{ needs.frontend-checks.result }}"
          BACKEND_RESULT="${{ needs.backend-checks.result }}"
          DOCKER_RESULT="${{ needs.docker-checks.result }}"
          
          echo "## PR Checks Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend Checks | $FRONTEND_RESULT |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend Checks | $BACKEND_RESULT |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Checks | $DOCKER_RESULT |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$FRONTEND_RESULT" != "success" ] || [ "$BACKEND_RESULT" != "success" ] || [ "$DOCKER_RESULT" != "success" ]; then
            echo "❌ Some checks failed. Please review the logs above." >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "✅ All checks passed successfully!" >> $GITHUB_STEP_SUMMARY
          fi
