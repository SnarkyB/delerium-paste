name: PR Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  ai-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Get PR details
        id: pr-info
        run: |
          PR_TITLE=$(gh pr view ${{ github.event.pull_request.number }} --json title --jq -r '.title')
          PR_BODY=$(gh pr view ${{ github.event.pull_request.number }} --json body --jq -r '.body')
          PR_AUTHOR=$(gh pr view ${{ github.event.pull_request.number }} --json author --jq -r '.author.login')
          BASE_BRANCH=$(gh pr view ${{ github.event.pull_request.number }} --json baseRefName --jq -r '.baseRefName')
          HEAD_BRANCH=$(gh pr view ${{ github.event.pull_request.number }} --json headRefName --jq -r '.headRefName')
          
          echo "pr_title<<EOF" >> $GITHUB_OUTPUT
          echo "$PR_TITLE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "pr_body<<EOF" >> $GITHUB_OUTPUT
          echo "$PR_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "pr_author=$PR_AUTHOR" >> $GITHUB_OUTPUT
          echo "base_branch=$BASE_BRANCH" >> $GITHUB_OUTPUT
          echo "head_branch=$HEAD_BRANCH" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get PR diff
        id: pr-diff
        run: |
          # Get diff and truncate if too long (API has limits)
          DIFF=$(gh pr diff ${{ github.event.pull_request.number }} | head -c 50000)
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          CHANGED_FILES=$(gh pr diff ${{ github.event.pull_request.number }} --name-only | head -20)
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Read repository guidelines
        id: guidelines
        run: |
          if [ -f "CLAUDE.md" ]; then
            GUIDELINES=$(head -300 CLAUDE.md)
          else
            GUIDELINES="No CLAUDE.md found"
          fi
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$GUIDELINES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate AI review
        id: review
        run: |
          # Build review prompt (Cursor Agent style)
          PROMPT=$(cat <<'PROMPT_EOF'
You are Cursor Agent, an AI code reviewer integrated into GitHub Actions. You review pull requests with the same intelligence and style as Cursor's built-in AI assistant.

You are reviewing a pull request for a zero-knowledge encrypted paste system. This is a security-critical application where all encryption happens client-side.

**PR Details:**
- Title: ${{ steps.pr-info.outputs.pr_title }}
- Author: ${{ steps.pr-info.outputs.pr_author }}
- Base: ${{ steps.pr-info.outputs.base_branch }} ‚Üí Head: ${{ steps.pr-info.outputs.head_branch }}

**PR Description:**
${{ steps.pr-info.outputs.pr_body }}

**Changed Files:**
${{ steps.pr-diff.outputs.changed_files }}

**Repository Guidelines:**
${{ steps.guidelines.outputs.content }}

**Code Diff:**
```
${{ steps.pr-diff.outputs.diff }}
```

Please provide a comprehensive code review focusing on:

1. **Security (CRITICAL - Zero-Knowledge Architecture):**
   - Encryption/decryption correctness (AES-256-GCM)
   - Key handling (must NEVER be sent to server - only in URL fragments)
   - Password handling and PBKDF2 derivation
   - Input validation
   - Error messages that might leak sensitive data
   - Logging of sensitive information (keys, passwords, plaintext)
   - Zero-knowledge compliance

2. **Code Quality:**
   - Adherence to project conventions (see CLAUDE.md)
   - TypeScript strict mode compliance
   - Code organization and structure
   - SOLID principles

3. **Testing:**
   - Test coverage (minimum 85% overall, 100% for security-critical code)
   - Edge cases covered (Unicode, empty strings, max sizes, etc.)
   - Security-critical paths tested
   - Integration and E2E tests where appropriate

4. **Potential Issues:**
   - Bugs or logic errors
   - Race conditions
   - Performance concerns
   - Breaking changes or API contract violations
   - Backward compatibility

5. **Documentation:**
   - Code comments and JSDoc
   - PR description completeness
   - Change documentation in docs/prs/ if needed

6. **Project-Specific:**
   - API contract preservation (never break existing contracts)
   - Coverage threshold maintenance (no drops >5%)
   - Small PR size (100-300 lines preferred)
   - Change documentation organization (docs/prs/PR-XXX-*/)

Provide specific, actionable feedback. Be constructive and helpful. Focus on security first, then code quality, then testing.

Format your review as a clear, well-structured comment that can be posted directly to the PR.
PROMPT_EOF
)
          
          # Call Anthropic API (same model Cursor Agent uses)
          echo "ü§ñ Cursor Agent reviewing PR..."
          
          REVIEW_RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            -H "x-api-key: ${{ secrets.ANTHROPIC_API_KEY }}" \
            -H "anthropic-version: 2023-06-01" \
            -H "content-type: application/json" \
            -d "{
              \"model\": \"claude-3-5-sonnet-20241022\",
              \"max_tokens\": 4000,
              \"messages\": [
                {
                  \"role\": \"user\",
                  \"content\": $(echo "$PROMPT" | jq -Rs .)
                }
              ]
            }")
          
          # Extract review text
          REVIEW_TEXT=$(echo "$REVIEW_RESPONSE" | jq -r '.content[0].text' 2>/dev/null || echo "")
          
          if [ -z "$REVIEW_TEXT" ] || [ "$REVIEW_TEXT" = "null" ]; then
            echo "‚ùå Error: Failed to get review from API"
            echo "Response: $REVIEW_RESPONSE"
            exit 1
          fi
          
          echo "review_text<<EOF" >> $GITHUB_OUTPUT
          echo "$REVIEW_TEXT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "‚úÖ Review generated successfully"

      - name: Post review as PR comment
        run: |
          echo "${{ steps.review.outputs.review_text }}" | gh pr comment ${{ github.event.pull_request.number }} --body-file -
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "‚úÖ PR Review completed!"
          echo "Review posted to PR #${{ github.event.pull_request.number }}"
          echo ""
          echo "Review preview:"
          echo "${{ steps.review.outputs.review_text }}" | head -20
