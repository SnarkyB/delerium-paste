name: PR Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  ai-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Get PR details
        id: pr-info
        run: |
          PR_TITLE=$(gh pr view ${{ github.event.pull_request.number }} --json title --jq '.title')
          PR_BODY=$(gh pr view ${{ github.event.pull_request.number }} --json body --jq '.body')
          PR_AUTHOR=$(gh pr view ${{ github.event.pull_request.number }} --json author --jq '.author.login')
          BASE_BRANCH=$(gh pr view ${{ github.event.pull_request.number }} --json baseRefName --jq '.baseRefName')
          HEAD_BRANCH=$(gh pr view ${{ github.event.pull_request.number }} --json headRefName --jq '.headRefName')
          
          echo "pr_title<<EOF" >> $GITHUB_OUTPUT
          echo "$PR_TITLE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "pr_body<<EOF" >> $GITHUB_OUTPUT
          echo "$PR_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "pr_author=$PR_AUTHOR" >> $GITHUB_OUTPUT
          echo "base_branch=$BASE_BRANCH" >> $GITHUB_OUTPUT
          echo "head_branch=$HEAD_BRANCH" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get PR diff
        id: pr-diff
        run: |
          DIFF=$(gh pr diff ${{ github.event.pull_request.number }} | head -c 50000)
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          CHANGED_FILES=$(gh pr diff ${{ github.event.pull_request.number }} --name-only | head -20)
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Read repository guidelines
        id: guidelines
        run: |
          if [ -f "CLAUDE.md" ]; then
            GUIDELINES=$(head -300 CLAUDE.md)
          else
            GUIDELINES="No CLAUDE.md found"
          fi
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$GUIDELINES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate AI review
        id: review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          PR_TITLE: ${{ steps.pr-info.outputs.pr_title }}
          PR_AUTHOR: ${{ steps.pr-info.outputs.pr_author }}
          BASE_BRANCH: ${{ steps.pr-info.outputs.base_branch }}
          HEAD_BRANCH: ${{ steps.pr-info.outputs.head_branch }}
          PR_BODY: ${{ steps.pr-info.outputs.pr_body }}
          CHANGED_FILES: ${{ steps.pr-diff.outputs.changed_files }}
          GUIDELINES: ${{ steps.guidelines.outputs.content }}
          DIFF: ${{ steps.pr-diff.outputs.diff }}
        run: |
          echo "Generating AI review..."
          
          # Build prompt using environment variables
          PROMPT="You are an AI code reviewer. Review this PR for a zero-knowledge encrypted paste system.

          PR Details:
          - Title: ${PR_TITLE}
          - Author: ${PR_AUTHOR}
          - Base: ${BASE_BRANCH} -> Head: ${HEAD_BRANCH}

          PR Description:
          ${PR_BODY}

          Changed Files:
          ${CHANGED_FILES}

          Repository Guidelines:
          ${GUIDELINES}

          Code Diff:
          ${DIFF}

          Focus on: Security (zero-knowledge architecture), Code Quality, Testing (85% coverage), Potential Issues, Documentation.
          Provide specific, actionable feedback."
          
          REVIEW_RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            -H "x-api-key: ${ANTHROPIC_API_KEY}" \
            -H "anthropic-version: 2023-06-01" \
            -H "content-type: application/json" \
            -d "{
              \"model\": \"claude-sonnet-4-20250514\",
              \"max_tokens\": 4000,
              \"messages\": [
                {
                  \"role\": \"user\",
                  \"content\": $(echo "$PROMPT" | jq -Rs .)
                }
              ]
            }")
          
          REVIEW_TEXT=$(echo "$REVIEW_RESPONSE" | jq -r '.content[0].text' 2>/dev/null || echo "")
          
          if [ -z "$REVIEW_TEXT" ] || [ "$REVIEW_TEXT" = "null" ]; then
            echo "Error: Failed to get review from API"
            echo "Response: $REVIEW_RESPONSE"
            exit 1
          fi
          
          echo "review_text<<EOF" >> $GITHUB_OUTPUT
          echo "$REVIEW_TEXT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "Review generated successfully"

      - name: Post review as PR comment
        run: |
          echo "${{ steps.review.outputs.review_text }}" | gh pr comment ${{ github.event.pull_request.number }} --body-file -
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "PR Review completed!"
          echo "Review posted to PR #${{ github.event.pull_request.number }}"
