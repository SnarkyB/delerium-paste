name: Automated Version Bump

on:
  release:
    types: [published]

permissions:
  contents: write
  pull-requests: write

jobs:
  bump-version:
    name: Bump to Next Version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract released version
        id: released_version
        run: |
          # Extract version from release tag (v1.0.7 -> 1.0.7)
          TAG_NAME="${{ github.event.release.tag_name }}"
          VERSION=$(echo "$TAG_NAME" | sed 's/^v//')
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Released version: $VERSION"

      - name: Calculate next version
        id: next_version
        run: |
          CURRENT_VERSION="${{ steps.released_version.outputs.version }}"
          
          # Increment patch version (1.0.7 -> 1.0.8)
          IFS='.' read -r major minor patch <<< "$CURRENT_VERSION"
          NEXT_PATCH=$((patch + 1))
          NEXT_VERSION="$major.$minor.$NEXT_PATCH"
          
          echo "next_version=$NEXT_VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT_VERSION"
          echo "Next version: $NEXT_VERSION"

      - name: Create version bump branch
        run: |
          BRANCH_NAME="chore/bump-version-${{ steps.next_version.outputs.next_version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "$BRANCH_NAME"
          echo "branch=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Bump version
        run: |
          chmod +x scripts/bump-version.sh
          ./scripts/bump-version.sh "${{ steps.next_version.outputs.next_version }}"

      - name: Commit version bump
        run: |
          git add -A
          git commit -m "chore: bump version to v${{ steps.next_version.outputs.next_version }}"
          git push origin "$BRANCH_NAME"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ env.branch }}
          title: "chore: bump version to v${{ steps.next_version.outputs.next_version }}"
          body: |
            Automated version bump after release ${{ github.event.release.tag_name }}
            
            This PR bumps the version from **${{ steps.released_version.outputs.version }}** to **${{ steps.next_version.outputs.next_version }}**.
            
            Changes:
            - Updated `client/package.json`
            - Updated `MODULE.bazel`
            - Updated HTML files (index.html, view.html, delete.html)
            - Updated test files
            - Updated API documentation
            
            Please review and merge to prepare for the next release.
          labels: |
            chore
            automated
          delete-branch: true
