name: Auto-generate PR Description

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  generate-description:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history needed for git diff

      - name: Generate PR description
        id: generate-desc
        run: |
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          
          echo "Generating PR description..."
          echo "Base: $BASE_SHA"
          echo "Head: $HEAD_SHA"
          
          # Generate description
          DESCRIPTION=$(./scripts/generate-pr-description.sh "$BASE_SHA" "$HEAD_SHA")
          
          # Save to output for debugging
          echo "$DESCRIPTION" > /tmp/pr-description.txt
          echo "Generated description:"
          echo "$DESCRIPTION"
          
          # Read existing PR body
          CURRENT_BODY=$(gh pr view ${{ github.event.pull_request.number }} --json body --jq '.body' || echo "")
          
          # Check if description was already auto-generated (has BOT_START marker)
          if echo "$CURRENT_BODY" | grep -q "<!-- BOT_START -->"; then
            echo "PR description already has bot-generated content, updating..."
            # Replace content between BOT_START and BOT_END
            NEW_BODY=$(echo "$CURRENT_BODY" | sed '/<!-- BOT_START -->/,/<!-- BOT_END -->/c\
<!-- BOT_START -->\
'"$DESCRIPTION"'\
<!-- BOT_END -->')
          else
            echo "No bot-generated content found, appending to template..."
            # Read PR template
            TEMPLATE=$(cat .github/pull_request_template.md 2>/dev/null || echo "")
            if [ -n "$TEMPLATE" ]; then
              # Replace placeholder in template
              NEW_BODY=$(echo "$TEMPLATE" | sed '/<!-- BOT_START -->/,/<!-- BOT_END -->/c\
<!-- BOT_START -->\
'"$DESCRIPTION"'\
<!-- BOT_END -->')
            else
              # Fallback: just use generated description
              NEW_BODY="$DESCRIPTION"
            fi
          fi
          
          # Update PR description
          echo "$NEW_BODY" | gh pr edit ${{ github.event.pull_request.number }} --body-file -
          
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "âœ… PR description auto-generated successfully"
          echo "View PR: https://github.com/${{ github.repository }}/pull/${{ github.event.pull_request.number }}"
