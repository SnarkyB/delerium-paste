# DISABLED: Using Cursor Agent-style review instead
# Uncomment below to re-enable Claude Code reviews

# name: Claude Code Review
#
# on:
#   pull_request:
#     types: [opened, synchronize]
    # Optional: Only run on specific file changes
    # paths:
    #   - "client/src/**/*.ts"
    #   - "server/src/**/*.kt"
    #   - ".github/workflows/**"

jobs:
  claude-review:
    # Optional: Filter by PR author
    # Uncomment to only review PRs from external contributors or first-time contributors
    # if: |
    #   github.event.pull_request.user.login == 'external-contributor' ||
    #   github.event.pull_request.user.login == 'new-developer' ||
    #   github.event.pull_request.author_association == 'FIRST_TIME_CONTRIBUTOR'

    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write  # Required to post reviews and comments
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better context

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}
            BASE BRANCH: ${{ github.event.pull_request.base.ref }}
            HEAD BRANCH: ${{ github.event.pull_request.head.ref }}

            Please review this pull request and provide comprehensive feedback on:

            **Code Quality:**
            - Code style and adherence to project conventions (see CLAUDE.md)
            - SOLID principles and best practices
            - Code organization and structure

            **Security (CRITICAL for this zero-knowledge system):**
            - Encryption/decryption implementations
            - Key handling (must never be sent to server)
            - Password handling and authentication
            - Input validation
            - Error messages that might leak sensitive data
            - Logging of sensitive information

            **Testing:**
            - Test coverage (minimum 85%, 100% for security-critical code)
            - Edge cases covered
            - Integration and E2E tests where appropriate
            - Tests for security-critical paths

            **Potential Issues:**
            - Bugs or logic errors
            - Race conditions
            - Performance concerns
            - Breaking changes or backward compatibility

            **Documentation:**
            - Code comments and documentation
            - PR description completeness
            - Change documentation in docs/prs/ if needed

            **Project-Specific:**
            - Zero-knowledge architecture compliance
            - API contract preservation
            - Coverage threshold maintenance (no drops >5%)
            - Small PR size (100-300 lines preferred)

            Use the repository's CLAUDE.md and .cursorrules for detailed guidance on:
            - Security requirements
            - Testing standards
            - API contract rules
            - Code style conventions

            Be constructive and helpful in your feedback. Focus on actionable improvements.

            Use `gh pr comment` with your Bash tool to leave your review as a comment on the PR.
            You can also use `gh pr review --approve` or `gh pr review --request-changes` if appropriate.

          # See https://github.com/anthropics/claude-code-action/blob/main/docs/usage.md
          # or https://docs.claude.com/en/docs/claude-code/cli-reference for available options
          claude_args: '--allowed-tools "Bash(gh pr comment:*),Bash(gh pr review:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*),Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*)"'
