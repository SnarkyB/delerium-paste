#!/bin/bash
# Pre-PR Check Script
# Runs all checks that CI will run to catch issues before pushing

set -e  # Exit on any error

echo "?? Starting pre-PR checks..."
echo ""

# Store the root directory
ROOT_DIR=$(pwd)

# Clean
echo "????????????????????????????????????????"
echo "1??  Cleaning build artifacts..."
echo "????????????????????????????????????????"
cd "$ROOT_DIR/client"
rm -rf coverage
cd "$ROOT_DIR"

# Install dependencies
echo ""
echo "????????????????????????????????????????"
echo "2??  Installing dependencies..."
echo "????????????????????????????????????????"
cd "$ROOT_DIR/client"
npm install --silent

# Build TypeScript
echo ""
echo "????????????????????????????????????????"
echo "3??  Building TypeScript..."
echo "????????????????????????????????????????"
./node_modules/.bin/tsc
echo "? TypeScript build successful"

# Type check
echo ""
echo "????????????????????????????????????????"
echo "4??  Type checking..."
echo "????????????????????????????????????????"
./node_modules/.bin/tsc --noEmit
echo "? Type check passed"

# Lint
echo ""
echo "????????????????????????????????????????"
echo "5??  Running ESLint..."
echo "????????????????????????????????????????"
npm run lint
echo "? ESLint passed"

# Tests
echo ""
echo "????????????????????????????????????????"
echo "6??  Running tests..."
echo "????????????????????????????????????????"
npm test
echo "? All tests passed"

# Coverage
echo ""
echo "????????????????????????????????????????"
echo "7??  Checking test coverage..."
echo "????????????????????????????????????????"
npm run test:coverage 2>&1 | tail -20
echo "? Coverage check complete"

# Build server
echo ""
echo "????????????????????????????????????????"
echo "8??  Building server..."
echo "????????????????????????????????????????"
cd "$ROOT_DIR/server"
./gradlew build --quiet
echo "? Server build successful"

# Success!
echo ""
echo "????????????????????????????????????????"
echo "? All pre-PR checks passed!"
echo "????????????????????????????????????????"
echo ""
echo "? Ready to create PR!"
echo ""
echo "Next steps:"
echo "  1. Review your changes: git status"
echo "  2. Stage files: git add <files>"
echo "  3. Commit: git commit -m 'your message'"
echo "  4. Push: git push"
echo "  5. Create PR on GitHub"
echo ""

cd "$ROOT_DIR"
